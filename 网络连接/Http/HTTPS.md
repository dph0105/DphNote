## 一、什么是HTTPS

HTTPS的全称为**HyperText Transfer Protocol over SecureSocket Layer**，即基于SecureSocket层的超文本传输协议。HTTPS是以安全为目标的HTTP通道，在HTTP的基础上，通过新增的SSL层使数据的安全得到保障。

## 二、为什么需要HTTPS

说到为什么需要HTTPS，就需要与HTTP对比来看。HTTP协议虽然使用广泛，但是存在不小的安全缺陷

1. HTTP使用明文传输数据

   由于HTTP使用明文数据传输，攻击者可以在传输过程中分析出敏感的数据，例如用户的隐私信息，包括手机号码、身份证号码等。

2. HTTP无法验证数据的完整性

   HTTP协议在传输数据时，唯一的数据完整性验证就是在报文头部包含了本次传输数据的长度，而对内容没有验证。因此无法确认内容是否被篡改过。

HTTPS主要通过数字证书、加密算法等技术实现网络数据安全保护，相较于HTTP，HTTPS的优势主要有三个：

1. 数据保密性：通过对称加密数据，保证数据在传输过程中不被第三方查看
2. 数据完整性：通过签名验证数据的完整性，确保数据没有被篡改
3. 身份校验安全性：保证数据到达用户期望的目的地

## 三、HTTPS如何解决问题

HTTP协议位于应用层，当我们使用HTTP协议进行网络通信时，HTTP协议完成自身的工作后，就将任务交给传输层中的TCP协议，依此类推TCP协议将工作会传递给网络层中的IP协议最后通过链路层将数据传输到网络中。

这就类似与我们设计代码时的封装，TCP就是传输层封装好的一套接口交给HTTP使用。而HTTPS并不直接使用，而是通过一层SSL/TLS层去使用。加入一层SSL的目的就是为了解决HTTP协议中的不安全的问题

![](https://segmentfault.com/img/remote/1460000017544858?w=543&h=248)

## 四、HTTPS的传输过程

想要发起HTTPS请求，我们需要通过某种方式告知服务器去执行HTTPS协议版本，一般这是再URL方案中实现的。当URL的前缀位http时，客户端就会打开一条到服务器端口80（默认情况下）的连接，并发送HTTP命令；如果URL的前缀为https，客户端就会打开一条到服务器端口443（默认情况下）的连接，然后**进行SSL握手，对加密参数进行沟通（通过非对称加密和数字证书），并交换密钥，最后进行加密的数据传输（通过对称加密）。**

HTTPS的SSL层是建立在TCP之上的，即SSL的握手也是通过TCP连接完成的。

### 1. Client Hello

![](imgs\https_连接过程1.png)

第一步称为Client Hello ，即客户端向服务器发送HTTPS请求，建立了到服务器443端口的连接后，客户端会向服务器发送**客户端随机数**和**客户端支持的加密算法**（对称加密、非对称加密、Hash算法）以及**客户端支持的SSL/TLS版本**。

### 2. Server Hello

![](imgs\https_连接过程2.png)

第二步称为Server Hello ,即服务端接收到客户端请求后，会向客户端发送**服务器随机数**和**服务器选择的加密算法**（这个加密算法一定是客户端发送给服务器的加密算法的子集）以及**服务器选择的SSL/TLS版本**。

**此时客户端和服务器已经确定好双方的SSL/TLS版本和加密算法**，并且他们都持有对方的随机数，在后面的步骤中，通过这些参数，客户端和服务器就能协商出对称加密算法的密钥，用于数据加密传输

### 3. 服务器发送证书

![](imgs\https_连接过程3.png)

第二步之后，紧接着服务器会向客户端发送证书。**而核心是服务器是向客户端发送它的公钥，对应的服务器自身持有私钥。**客户端得到服务器的公钥之后，就可以通过公钥加密商讨出来的对称加密的密钥并发送给服务器了。

那么为什么要通过证书发送公钥呢？这是由于非对称加密也并非安全的，攻击者可以截取服务器的公钥，并创建自己的公钥私钥，然后将自己的公钥发送给客户端，客户端将数据通过该攻击者的公钥加密后发送出去，被攻击者用私钥解密后，可以轻易的篡改信息，再通过服务器的公钥加密并发送给服务器。而数字证书正是用于保护公钥不被泄漏。

通过证书就可以确定服务器的身份。证书是服务器向CA机构申请得到的，它的内容一般包含服务器的地址、服务器的公钥、证书的有效期、证书颁发者、证书的签名算法、证书的数字签名等。**证书的数字签名是证书颁发者（CA机构）通过它的私钥对其他内容进行签名得到的，而其他内容都是明文**。为什么需要签名呢？因为没有签名，我们无法证明这个证书没有被篡改过。

### 4. 客户端验证证书

![](imgs\https_连接过程4.png)

1. 验证证书的有效期

   如果证书过期了，或者还未被激活，则证书有效性验证失败。

2. 验证证书颁发者

   证书的签名是通过证书颁发者的私钥加密生成的，若想要验证证书签名则需要得到证书颁发者的公钥。证书中包含了它的颁发者的信息，但是并没有证书颁发者的公钥，若想得到该公钥，则需要验证证书颁发者上一级颁发者的证书，而上一级证书的验证则又需要它的上一级验证。目前一般有三级证书：

   ![](imgs\证书路径.png)

   最顶端的证书被称为根证书，根证书来自我们的操作系统，它是被我们操作系统的研发方认证的，所以只要我们的操作系统没有问题，则我们是可以信任根证书的。

   当然，如果我们自己安装了其他根证书，那么该证书的安全性就无法得到保证。

3. 验证签名

   验证证书颁发者机构后，我们可以根据证书链得到服务器发送的证书的公钥，通过公钥验证签名即可得到证书信息的摘要（通过hash算法得到的摘要），证书中包含证书摘要的Hash算法，重新计算摘要与签名得到的摘要相同，则证明证书正确。

### 5.客户端生成Session Secret Key

![](imgs\https_连接过程5.png)

**Session Secret Key即会话密钥，是HTTPS之后进行数据传输的对称加密的密钥**。在创建会话密钥之前，客户端首先会再次生成一个随机数即**Premaster Secret（预主密钥）**，然后通过预主密钥、客户端随机数和服务端随机数创建会话密钥。

### 6.客户端发送Premaster Secret

![](imgs\https_连接过程6.png)

客户端向服务器发送Premaster Secret，服务器通过私钥解密后，与客户端随机数、服务端随机数通过相同的方式组装成会话密钥。

### 7.传送消息验证密钥有效

客户端和服务器都通过相同的方式组装完会话密钥后，客户端会发送一条加密消息到服务器，验证服务器是否能接收客户端加密的消息。同样服务器也会向客户端发送一条加密的消息，验证客户端是否能接收服务器加密消息。

验证完成，则SSL层连接建立完成！接下来客户端就可以向服务器发送HTTPS请求了！



### 补充

在上面七步的流程中，我们可以发现HTTPS通过证书解决了**身份校验的问题**、通过非对称加密和对称加密解决了**数据保密性的问题**。但是我们并没有看到HTTPS是如何解决**数据完整性的问题**

其实，客户端和服务器组装的会话密钥不是只有一条。而是四条：分别是客户端密钥、服务器密钥、                    客户端MAC Secret、服务器MAC Secret。MAC即 Message Authentication Code （消息验证码）。

当客户端向服务端发送消息时，消息通过客户端密钥加密，通过客户端MAC Secret进行消息摘要。服务器接收到消息后，通过客户端密钥解密，并通过客户端MAC Secret也进行消息摘要，若与接收到的摘要相同则证明数据完整。



