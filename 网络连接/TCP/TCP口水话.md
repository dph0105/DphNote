TCP协议是一种面向连接的、可靠的、基于字节流的、全双工的传输层通信协议

**面向连接**指通信双方必须先进行三次握手建立连接才能进行数据的传输，结束通信时也需要四次挥手来断开连接

**可靠**则是指：

1. TCP发送的每个报文段都必须得到接收方的应答才认为这个TCP报文段传输成功，即每个报文都会带上一个**序列号**，接收方收到数据，必须回复的数据有**序列号+1**
2. 发送端发送一个报文段后启动定时器，如果在一定事件内没有收到应答就重新发送这个报文段
3. TCP通过校验和来检验数据是否有错误
4. 流量控制和阻塞管理，避免主机发送得过快而使接收方来不及完全收下

**基于字节流**指TCP传输的数据是字节，字节流没有固定的报文边界，所以需要程序自定义自己的消息分隔符

**全双工**指通信的双方在任意时刻都能发送数据和接受数据

**建立TCP连接需要三次握手**

1. 首先客户端向服务器发送SYN包，并且会携带一个序列号X，然后进入SYN_SENT状态。

2. 服务器收到SYN包，会向客户端发送ACK包携带序列号（X+1），表示确认；并且服务器会向客户端发送一个SYN包携带另一个序列号Y。由于SYN包一把不携带数据，收到客户端的SYN包之后，服务器可以把这两步合起来，直接回复SYN+ACK包

3. 客户端收到SYN+ACK包后，设置状态为ESTABLISHED，向服务器发送ACK包携带序列号Y+1，服务器收到后，也设置状态为ESTABLISHED。然后通信双方就成功建立连接了

三次握手的主要目的是为了保证连接是全双工的，只有两次的话，只能保证一端的通信是正常的。

**TCP断开连接需要四次挥手**

1. 客户端想要断开连接，向服务端发送FIN包，并进入FIN_WAIT_1状态

2. 服务器收到FIN包，会向客户端发送ACK包，表示确认收到，并进入CLOSE_WAIT状态。客户端收到ACK包后，进入FIN_WAIT_2状态。

3. 服务端可能还有未发送的数据，等待发送结束后，会向客户端发送FIN包，并进入LAST_ACK状态，如果没有收到客户端的ACK包，会重新发送FIN包

4. 客户端收到FIN包后，向服务器发送ACK包确认，进入TIME_WAIT状态，等待2个MSL后关闭连接。服务器收到ACK包后，关闭连接

MSL指报文最大生存事件（Maximum Segment Lifetime），指报文在网络中最长存在的时间

等待两个MSL可以保证，ACK包和重新发送的FIN包都丢失了，这样才会重新发送ACK包

