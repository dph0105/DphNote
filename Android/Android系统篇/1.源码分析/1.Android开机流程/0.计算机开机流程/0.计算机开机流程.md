首先先来了解一下几个名词：

**BIOS**（Basic Input Output System）基本输入输出系统：

	1. 传统BIOS即 Legacy BIOS，支持MBR分区
 	2. 新式BIOS即 UEFI BIOS，支持GPT分区

**MBR**（Master Boot Record）分区：

MBR的意思是“主引导记录”，它有自己的启动器，也就是启动代码，一旦启动代码被破坏，系统就没法启动，只有通过修复才能启动系统。最大支持2TB容量。

**GPT**（GUID Partition Table）分区：

GPT意为"全局唯一标识磁盘分区表"，这是一个正逐渐取代MBR的新标准，它由UEFI辅住而形成的，这样就有了UEFI用于取代老旧的BIOS，而GPT则取代老旧的MBR。这个标准没有MBR的那些限制。磁盘驱动器容量可以大得多，大到操作系统和文件系统都没法支持。它同时还支持几乎无限个分区数量，限制只在于操作系统，Windows支持最多128个GPT分区。



计算机是如何启动的？

我们知道程序都是存放在硬盘上的，计算机操作系统也一样，如Windows系统一般安装在C盘，当我们要启动计算机时，就需要加载硬盘中的操作系统并运行。

### 1.引导阶段

计算机开机时首先启动的是主板芯片上的BIOS程序，BIOS程序启动后，首先进行 POST（Power-On Self-Test）硬件自检，检查计算机硬件是否满足运行的基本条件（UEFI BIOS 也会有自检过程，只不过这一步并不是必须的，传统Legacy BIOS中，硬件自检是一个固定流程）

硬件自检完成后，BIOS会将控制权转交到下一阶段的启动程序，BIOS需要知道下一个启动程序的位置。BIOS会按照设置的顺序读取硬盘中MBR分区中的信息。

![](\imgs\bios_boot_device.png)

MBR 只有512个字节，放不了太多东西。他的主要作用就是引导操作系统，以及记录分区信息

主引导记录由三个部分组成：

第 0 - 445 字节：操作系统启动代码。
第 446- 509字节：分区表（Partition table）。
第 510 - 511 字节：主引导记录签名（0x55AA）。

其中，第二部分「分区表」的作用，就是将硬盘分成若干个区。硬盘分区有很多好处，考虑到每个区可以安装不同的操作系统，「主引导记录」因此必须知道将控制权转交给哪个区。

分区表的长度只有 64 个字节，里面又分成四项，每项 16 个字节。所以，一个硬盘最多只能分四个一级分区，又叫做「主分区」。

四个主分区里面，只有一个是激活的（也称为活动的）。计算机会读取激活分区的第一个扇区，叫做卷引导记录（Volume boot record，缩写为 VBR ）。卷引导记录的主要作用是，告诉计算机，操作系统在这个分区里的位置。

如果这 512 个字节的最后两个字节是 0x55 AA ，表明这个设备可以用于启动；如果不是，表明设备不能用于启动，控制权于是被转交给启动顺序中的下一个设备。

当操作系统安装时，会安装该操作系统的**开机管理程序（Boot Loader）**到MBR的前446个字节中，每个操作系统都有自己的Boot Loader，通过Loader加载操作系统的核心到内存中执行。

### 2.加载内核阶段

操作系统的核心加载完成后，控制权会转交给操作系统，操作系统进行相应的工作。以Linux系统为例，Linux的Boot Loader载入Kernel，Kernel会开始侦测硬件与载入驱动程序。此时主机硬件准备就绪，Kernel会调用第一支程序systemd（systemd取代了以前的init），systemd的主要功能是准备软件执行的环境，包括系统的主机名称、网络设置、文件系统格式等服务启动，所有的动作会通过systemd的默认启动服务集合（/etc/systemd/system/default.target)来规划。

一直到登录程序执行，跳出登录页面，等待用户输入用户名和密码，即系统启动完成



若硬盘上安装了多个操作系统呢？硬盘的MBR分区只有一个，因此在操作系统安装时会覆盖掉MBR分区上的信息。而每个操作系统也会安装一份Boot Loader到他根目录所在的文件系统的boot sector上。如果我们同时安装了Windows操作系统和Linux操作系统，此时的开机流程是，BIOS加载MBR分区中Linux的 Boot Loader（一般是Grub），此时会显示菜单：

选项一：直接指向Linux的核心文件，并载入核心开机

选项二：将开机管理权转交给Windows的Boot Loader （Windows Boot Manager）

选项三：使用Linux在boot sector内的Boot Loader，此时会跳出另一个Grub的菜单。

由于Window Boot Manager默认不具有转移开机控制权的功能，所以我们需要后安装Linux覆盖Windows在MBR分区中的Boot Loader。



GPT分区中，也存在一个类似的MBR块，叫做PMBR，其中包含主引导代码，因此过程是类似的。

